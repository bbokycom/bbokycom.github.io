<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CS180/280A Project #4: Neural Radiance Field!</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .logo-bar {
            display: flex;
            align-items: center;
            gap: 1em;
            margin-bottom: 1.5em;
        }
        .logo-bar img {
            height: 60px;
        }
        .section {
            margin-bottom: 2.5em;
        }
        .subsection {
            margin-bottom: 1.5em;
        }
        .outline-list {
            margin-left: 2em;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-bar">
            <div>
                <h1>Programming Project #4 (proj4)</h1>
                <h2>CS180: Intro to Computer Vision and Computational Photography</h2>
                <h3>Neural Radiance Field!</h3>
                <p>https://bbokycom.github.io/4/index.html</p>
            </div>
        </div>
    </header>
    <main>
        <section class="section">
            <h2>Part 0: Camera Calibration and 3D Scanning</h2>
            <h3>Screenshots of Camera Frustums</h3>
            <p>These are screenshots of the camera frustums visualized in Viser, depicting the positions and orientations of the cameras used to take pictures of a red cup.</p>
            <div style="display: flex; gap: 2em; justify-content: flex-start; align-items: flex-end; margin-bottom:2em;">
                <figure style="margin:0; flex:1; text-align:center;">
                    <img src="./p0/s3.png" alt="Camera Frustum Screenshot 1" style="width:100%; max-width:320px; height:auto; box-shadow:0 2px 8px #0001;">
                    <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Screenshot 1</figcaption>
                </figure>
                <figure style="margin:0; flex:1; text-align:center;">
                    <img src="./p0/s4.png" alt="Camera Frustum Screenshot 2" style="width:100%; max-width:320px; height:auto; box-shadow:0 2px 8px #0001;">
                    <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Screenshot 2</figcaption>
                </figure>
            </div>
        </section>
        <section class="section">
            <h2>Part 1: Fit a Neural Field to a 2D Image</h2>
            <div class="subsection">
                <h3>Model Architecture</h3>
                <p>For the model architecture to fit a 2D image, I used an MLP. The network takes in a 2D coordinate (x,y) as input, and expands the dimensionality using position encoding with maximum frequency of 10. The positional encodings are then passed through four linear layers with ReLU activations, and the last layer has a Sigmoid activation to output RGB values between 0 and 1.</p>
                <p>
                    For optimization and learning rate, I used the Adam optimizer with a learning rate of 5e-4.
                </p>
                <h3>Results on Test Images</h3>
                <p>Here is the intermediate results visualization on the given test image:</p>
                <div style="margin-bottom: 1.5em;">
                    <h3 style="margin-bottom: 0.5em;">Training Progression (Fox)</h3>
                    <div style="display: flex; flex-direction: column; gap: 1em;">
                        <div style="display: flex; gap: 2em; justify-content: flex-start; align-items: flex-end;">
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/fox/epoch_0.png" alt="Epoch 0" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 0</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/fox/epoch_10.png" alt="Epoch 10" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 10</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/fox/epoch_100.png" alt="Epoch 100" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 100</figcaption>
                            </figure>
                        </div>
                        <div style="display: flex; gap: 2em; justify-content: flex-start; align-items: flex-end;">
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/fox/epoch_500.png" alt="Epoch 500" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 500</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/fox/epoch_1499.png" alt="Epoch 1499" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 1499</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/fox/epoch_1999.png" alt="Epoch 1999" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 1999</figcaption>
                            </figure>
                        </div>
                    </div>
                </div>
                <div style="margin-top:2em; text-align:center;">
                    <figure style="display:inline-block; margin:0;">
                        <img src="./p1/fox/epoch_1999.png" alt="Final Result Epoch 1999" style="width:100%; max-width:600px; height:auto;">
                        <figcaption style="margin-top:0.75em; font-size:1.15em; color:#333;">Final Result (Epoch 1999)</figcaption>
                    </figure>
                </div>
                <p>Here is the PSNR plot for the fox model:</p>
                <div style="text-align:center; margin-bottom:2em;">
                    <figure style="display:inline-block; margin:0;">
                        <img src="./p1/fox/psnr_plot.png" alt="PSNR Plot for Fox Model" style="width:100%; max-width:500px; height:auto;">
                        <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">PSNR Curve for Fox Model</figcaption>
                    </figure>
                </div>
                <h3>Results on Your Own Image (Yummy Rice)</h3>
                <p>Here is the intermediate results visualization on my own image:</p>
                <div style="margin-bottom: 1.5em;">
                    <h3 style="margin-bottom: 0.5em;">Training Progression (Yummy Rice)</h3>
                    <div style="display: flex; flex-direction: column; gap: 1em;">
                        <div style="display: flex; gap: 2em; justify-content: flex-start; align-items: flex-end;">
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/yummyrice/epoch_0.png" alt="Yummy Rice Epoch 0" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 0</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/yummyrice/epoch_10.png" alt="Yummy Rice Epoch 10" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 10</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/yummyrice/epoch_100.png" alt="Yummy Rice Epoch 100" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 100</figcaption>
                            </figure>
                        </div>
                        <div style="display: flex; gap: 2em; justify-content: flex-start; align-items: flex-end;">
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/yummyrice/epoch_500.png" alt="Yummy Rice Epoch 500" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 500</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/yummyrice/epoch_1499.png" alt="Yummy Rice Epoch 1499" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 1499</figcaption>
                            </figure>
                            <figure style="margin:0; flex:1; text-align:center;">
                                <img src="./p1/yummyrice/epoch_1999.png" alt="Yummy Rice Epoch 1999" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 1999</figcaption>
                            </figure>
                        </div>
                    </div>
                </div>
                <div style="margin-top:2em; text-align:center;">
                    <figure style="display:inline-block; margin:0;">
                        <img src="./p1/yummyrice/epoch_1999.png" alt="Final Result Yummy Rice Epoch 1999" style="width:100%; max-width:600px; height:auto;">
                        <figcaption style="margin-top:0.75em; font-size:1.15em; color:#333;">Final Result (Epoch 1999)</figcaption>
                    </figure>
                </div>
                <p>Here is the PSNR plot for the Yummy Rice model:</p>
                <div style="text-align:center; margin-bottom:2em;">
                    <figure style="display:inline-block; margin:0;">
                        <img src="./p1/yummyrice/psnr_plot.png" alt="PSNR Plot for Yummy Rice Model" style="width:100%; max-width:500px; height:auto;">
                        <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">PSNR Curve for Yummy Rice Model</figcaption>
                    </figure>
                </div>
                <h3>Comparison of Model Width and Positional Encoding Frequency</h3>
                <div style="margin-top:2em; text-align:center;">
                    <h4 style="margin-bottom:1em;">Final Results for Different Widths and Positional Encoding Frequencies</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 2em; justify-items: center;">
                        <figure style="margin:0;">
                            <img src="./p1/width_32_L_3/progress_images_log/epoch_1999.png" alt="Width 32, L=3" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Width 32, Max Freq 3</figcaption>
                        </figure>
                        <figure style="margin:0;">
                            <img src="./p1/width_32_L_10/progress_images_log/epoch_1999.png" alt="Width 32, Max Freq 10" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Width 32, Max Freq 10</figcaption>
                        </figure>
                        <figure style="margin:0;">
                            <img src="./p1/width_256_L_3/progress_images_log/epoch_1999.png" alt="Width 256, Max Freq 3" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Width 256, Max Freq 3</figcaption>
                        </figure>
                        <figure style="margin:0;">
                            <img src="./p1/fox/epoch_1999.png" alt="Width 256, Max Freq 10" style="width:100%; max-width:260px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Width 256, Max Freq 10</figcaption>
                        </figure>
                    </div>
                </div>
                We can clearly see that increasing model width and positional encoding frequency dramatically improves the quality of the reconstructed image. The model with width 256 and max frequency 10 produces the most accurate and detailed reconstruction, while the model with width 32 and max frequency 3 yields a much blurrier result with less detail.
        </section>
        <section class="section">
            <h2>Part 2: Fit a Neural Radiance Field from Multi-view Images</h2>
            <div class="subsection">
                <h3>How NERF was implemented</h3>
                <p>The first step was to create the ray generation process. This step necessitated three main parts:</p>
                <ol>
                    <li>Camera to World Transformation:</li>
                    <p>Given the <code>c2w</code> and a camera point, the function <code>camera_to_world</code> transforms the camera point to world coordinates in a batched manner.</p>
                    <li>Pixel to Camera Transformation:</li>
                    <p>Given the camera intrinsics matrix <code>K</code>, the (x,y) pixel coordinates, and the depth, the function <code>pixel_to_camera</code> converts pixel coordinates to camera coordinates (also batched).</p>
                    <li>Pixel to Ray Generation</li>
                    <p>Finally, the function <code>pixel_to_ray</code> generates rays from pixel coordinates by combining the previous transformations. It does this by transforming the given pixels to camera coordinates, which are then transformed to world coordinates. Using the world coordinate and the camera position, the function outputs the ray origin and ray direction.</p>
                </ol>
                <p>Now that the ray generation process was made, the next step involved sampling, both rays and the points along the rays.</p>
                <ol>
                    <li>Ray Sampling:</li>
                    <p>
                        The <code>sample_rays_inner</code> function randomly samples rays from a batch of images. For each image, it generates a meshgrid of pixel coordinates, randomly selects a subset, and uses <code>pixel_to_ray</code> to compute the ray origins and directions. The corresponding RGB values are gathered from the image at those pixel locations. Finally, all sampled rays and colors are concatenated and returned for use in training.
                    </p>
                    <li>Point Sampling Along Rays:</li>
                    <p>
                        Point sampling along rays uses evenly spaced depths <code>t_vals</code> between near and far bounds. If enabled, random jitter is added for diversity. Sample points are computed as <code>ray_origin + ray_direction * t</code>, resulting in a tensor of shape <code>[N_rays, n_samples, 3]</code>.
                    </p>
                </ol>
                <p>The next step was to create a dataloader that would give ray origins, directions, and colors for training.</p>
                <p>Now that we have the data, the NERF model was trained on a MLP with the following specifications:</p>
                <ul>
                    <li>The network takes a 3D point <code>x</code> and passes it through positional encoding to convert it into a high-frequency feature vector.</li>
                    <li>The encoded position flows through a deep stack of linear layers with ReLU activations, and midway through the network the original encoded input is concatenated back in as a skip connection.</li>
                    <li>After several more layers, the network branches: one branch outputs a single density value through a final linear layer followed by ReLU.</li>
                    <li>For color, the other branch takes the intermediate features and concatenates them with a separately encoded viewing direction <code>r_d</code>, then processes them through additional linear and ReLU layers.</li>
                    <li>The color branch ends with a linear layer followed by a sigmoid function to predict the final RGB value in the range [0, 1].</li>
                    <li>The MLP uses the Adam Optimizer for training, with a learning rate of 5e-4</li>
                </ul>
                <p>Finally, volume rendering is performed to integrate the colors and densities along each ray, producing the final pixel colors for the rendered image. This is fed into the loss function for training.</p>
                
                <h3>Visualization of Rays and Sample Points</h3>
                <div style="text-align:center; margin-bottom:2em;">
                    <figure style="display:inline-block; margin:0;">
                        <img src="./p2/lego_sphere.png" alt="Visualization of Rays and Sample Points (Lego Sphere)" style="width:100%; max-width:500px; height:auto;">
                        <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Visualization of Rays and Sample Points (Lego Sphere)</figcaption>
                    </figure>
                </div>
                <p>This image shows all the cameras and the rays projected from those cameras into the scene. The dots along the rays represent sample points.</p>

                <h3>Training Progress Visualizations for Lego Dataset</h3>
                <div style="margin-bottom: 2em;">
                    <h4 style="margin-bottom:1em;">Training Progression (Lego Dataset)</h4>
                    <div style="display: flex; gap: 2em; justify-content: flex-start; align-items: flex-end;">
                        <figure style="margin:0; flex:1; text-align:center;">
                            <img src="./p2/lego_intermediate/intermediate_0100.png" alt="Lego Epoch 100" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 100</figcaption>
                        </figure>
                        <figure style="margin:0; flex:1; text-align:center;">
                            <img src="./p2/lego_intermediate/intermediate_0300.png" alt="Lego Epoch 300" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 300</figcaption>
                        </figure>
                        <figure style="margin:0; flex:1; text-align:center;">
                            <img src="./p2/lego_intermediate/intermediate_0800.png" alt="Lego Epoch 800" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 800</figcaption>
                        </figure>
                        <figure style="margin:0; flex:1; text-align:center;">
                            <img src="./p2/lego_intermediate/intermediate_1500.png" alt="Lego Epoch 1500" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 1500</figcaption>
                        </figure>
                        <figure style="margin:0; flex:1; text-align:center;">
                            <img src="./p2/lego_intermediate/intermediate_2500.png" alt="Lego Epoch 2500" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 2500</figcaption>
                        </figure>
                    </div>
                </div>
                <p>We can see that at the 100th epoch, the model is very fuzzy and blurry, but as the training progresses, the image becomes clearer and more detailed.</p>
                <h3>PSNR Curve</h3>
                <div style="text-align:center; margin-bottom:2em;">
                    <figure style="display:inline-block; margin:0;">
                        <img src="./p2/lego_intermediate/nerf_psnr_plot.png" alt="PSNR Curve for Lego NERF Model" style="width:100%; max-width:500px; height:auto;">
                        <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">PSNR Curve for Lego NERF Model</figcaption>
                    </figure>
                </div>
                <h3>Spherical Rendering Video</h3>
                <p>Using the test cameras provided, this video was generated:</p>
                <div style="text-align:center; margin-bottom:2em;">
                    <video controls style="width:100%; max-width:600px; height:auto;">
                        <source src="./p2/lego_intermediate/lego_video.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Spherical Rendering Video of Lego Scene</figcaption>
                </div>
            </div>
        </section>
        <section class="section">
            <h2>Part 2.6: Training with Your Own Data</h2>
        </section>
        <h3>Camera Circling</h3>
        <div style="text-align:center; margin-bottom:2em;">
            <video controls style="width:100%; max-width:600px; height:auto;">
                <source src="./p2/cup_video.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Camera Circling Novel Views (Cup)</figcaption>
        </div>
        <h3>Changes Made</h3>
        To fit the cup dataset, I decreased the dimensionality of the positional encoding, as I noticed that the original high frequency could have caused overfitting. Besides that, I kept most of the hyperparameters the same as the Lego dataset, including the learning rate and model architecture. I also had to adjust the near and far bounds for sampling points along the ray to better suit the scale of the cup scene. I changed it from (2.0, 6.0) to (0.02, 0.7) to ensure that the sampled points covered the cup adequately.
        <h3>Training Loss Plot</h3>
        <div style="text-align:center; margin-bottom:2em;">
            <figure style="display:inline-block; margin:0;">
                <img src="./p2/cup_intermediate/training_loss.png" alt="Training Loss Plot (Cup)" style="width:100%; max-width:500px; height:auto;">
                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Training Loss Plot (Cup)</figcaption>
            </figure>
        </div>
        <h3>Intermediate Renders</h3>
        <div style="display: flex; gap: 2em; justify-content: flex-start; align-items: flex-end; margin-bottom:2em;">
            <figure style="margin:0; flex:1; text-align:center;">
                <img src="./p2/cup_intermediate/100.png" alt="Cup Epoch 100" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 100</figcaption>
            </figure>
            <figure style="margin:0; flex:1; text-align:center;">
                <img src="./p2/cup_intermediate/500.png" alt="Cup Epoch 500" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 500</figcaption>
            </figure>
            <figure style="margin:0; flex:1; text-align:center;">
                <img src="./p2/cup_intermediate/1000.png" alt="Cup Epoch 1000" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 1000</figcaption>
            </figure>
            <figure style="margin:0; flex:1; text-align:center;">
                <img src="./p2/cup_intermediate/2500.png" alt="Cup Epoch 2500" style="width:100%; max-width:220px; height:auto; box-shadow:0 2px 8px #0001;">
                <figcaption style="margin-top:0.5em; font-size:1em; color:#444;">Epoch 2500</figcaption>
            </figure>
        </div>
    </main>
</body>
</html>
