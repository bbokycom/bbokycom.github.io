<!DOCTYPE html>
<html lang="en">
<head>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=default'></script>
  <meta charset="UTF-8">
  <title>CS180 Project 5 – Diffusion Models</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      max-width: 900px;
      margin: auto;
      font-family: Arial, sans-serif;
      line-height: 1.5;
    }
    header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 2em;
    }
    header img {
      height: 70px;
    }
    h1, h2, h3 {
      margin-bottom: 0.4em;
    }
    .section {
      margin-bottom: 3em;
    }
    .image-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .image-block {
      text-align: center;
    }
    .image-block img {
      max-width: 260px;
      border: 1px solid #ccc;
    }
    .caption {
      font-size: 0.9em;
      color: #444;
    }
  </style>
</head>

<body>

<header>
  <div>
    <h1>Programming Project #5</h1>
    <h2>CS180: Intro to Computer Vision & Computational Photography</h2>
    <h3>University of California, Berkeley</h3>
  </div>
</header>

<hr>

<h1>Part A: The Power of Diffusion Models</h1>
<section class="section">
  <h2>Part 0: Setup</h2>
  <p>
    Here are the prompts I used:
    <ul>
        <li>"a high resolution studio portrait of a dog wearing a bowtie"</li>
        <li>"an oil painting of a ship sailing on a sea of grass"</li>
        <li>"a cinematic photo of the UC Berkeley campus"</li>
        <li>"a macro close up shot of a jumping spider"</li>
        <li>"a realistic iphone photo of a chef flipping a burger"</li>
        <li>"a panoramic view of the grand canyon filled with candy"</li>
        <li>"a photo of a cat"</li>
        <li>"a photo of a car"</li>
        <li>"an oil painting of a snowy village"</li>
        <li>"an oil painting of a birthday party"</li>
        <li>"a portrait of a queen"</li>
        <li>"a portrait of a tree"</li>
        <li>"a photo of a bee"</li>
        <li>"a photo of a sunset"</li>
    </ul>
  </p>
</section>

<section class="section">
    <h2>Play with the Model: Text-to-Image</h2>
    <p>
        The following images were generated using these prompts:
        <ul>
            <li><em>"a high resolution studio portrait of a dog wearing a bowtie"</em></li>
            <li><em>"a panoramic view of the grand canyon filled with candy"</em></li>
            <li><em>"a macro close up shot of a jumping spider"</em></li>
        </ul>
        Additionally, I set a random seed for reproducibility at 100.
    </p>
    <div class="image-row">
        <div class="image-block">
            <img src="A0/bowtie_dog_10.png">
            <div class="caption">Bowtie Dog (10 steps)</div>
        </div>
        <div class="image-block">
            <img src="A0/grand_canyon_10.png">
            <div class="caption">Grand Canyon (10 steps)</div>
        </div>
        <div class="image-block">
            <img src="A0/jumping_spider_10.png">
            <div class="caption">Jumping Spider (10 steps)</div>
        </div>
    </div>
    <div class="image-row">
        <div class="image-block">
            <img src="A0/bowtie_dog_20.png">
            <div class="caption">Bowtie Dog (20 steps)</div>
        </div>
        <div class="image-block">
            <img src="A0/grand_canyon_20.png">
            <div class="caption">Grand Canyon (20 steps)</div>
        </div>
        <div class="image-block">
            <img src="A0/jumping_spider_20.png">
            <div class="caption">Jumping Spider (20 steps)</div>
        </div>
    </div>
    <p>The quality of the images is reasonably high, and generally reflected the prompt well. It also seems that generally, as the number of steps goes up, the detail and quality of the image increases as well.The only one out of the three that was quite different from the prompt was the Grand Canyon filled with candy. This could be due to the model's difficulty in interpreting complex or unusual scenes.</p>
</section>

<section class="section">
  <h2>1.1 Forward Diffusion</h2>
  <p>To implement forward diffusion, I had to code out the following equation: 
    \(x_t = \sqrt{\bar{\alpha_t}} x_0 + \sqrt{1 - \bar{\alpha_t}} \epsilon\). To this end, I first got the \(\bar{\alpha_t}\) value from the <code>alphas_cumprod</code> array, which I then used to compute \(\bar{x_t}\) according to the equation above, also using a randomly sampled noise \(\epsilon\). The resulting noisy images for different time steps are shown below.
</p>
<div class="image-row" style="gap: 20px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Original</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_250.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">t = 250</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_500.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">t = 500</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_750.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">t = 750</div>
    </div>
</div>
</section>

<section class="section">
  <h2>1.2 Classical Denoising</h2>
  <p>To implement classical denoising, I simply used <code>torchvision.transforms.functional.gaussian_blur</code>. The results are shown below.</p>
<div class="image-row" style="gap: 20px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_250.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy (t = 250)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_500.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy (t = 500)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_750.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy (t = 750)</div>
    </div>
</div>
<div class="image-row" style="gap: 20px; margin-top: 10px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_blurred_250.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Gaussian Blur (t = 250)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_blurred_500.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Gaussian Blur (t = 500)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_blurred_750.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Gaussian Blur (t = 750)</div>
    </div>
</div>
<p>A Gaussian blur is applied to the noisy images to perform classical denoising. As you can see in the results above, the blur does smooth out the noise but still results in quite noisy and bad images.</p>
</section>

<section class="section">
  <h2>1.3 One-Step Denoising</h2>
  To implement one-step denoising, I essentially do the inverse of the forward diffusion process. Given a noisy image, I use the pretrained diffusion model to predict the noise, and then use that to estimate the clean image. 
<div class="image-row" style="gap: 20px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_250.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy (t = 250)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_500.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy (t = 500)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_noise_750.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy (t = 750)</div>
    </div>
</div>
<div class="image-row" style="gap: 20px; margin-top: 10px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_onestep_250.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">One-Step Denoising (t = 250)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_onestep_500.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">One-Step Denoising (t = 500)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_onestep_750.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">One-Step Denoising (t = 750)</div>
    </div>
</div>
<p>With the pretrained diffusion model, one-step denoising significantly improves the image quality compared to the classical denoising. However, as the last image shows, at high noises, it is still quite ineffective and blurry.</p>
</section>

<section class="section">
    <h2>1.4 Iterative Denoising</h2>
    <p>
        To implement iterative denoising, I divided the timesteps into intervals of 30, rather than performing the entire denoising in a single step. In the loop, I step from the starting timestep index down to the end, updating the image at each interval. At each step, I apply the denoising process similar to the one-step method, but iteratively for each time range, and save the predicted image at each stage.
    </p>
<div class="image-row" style="gap: 20px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_iterative_0.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy Campanile (t = 90)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_iterative_5.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy Campanile (t = 240)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_iterative_10.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy Campanile (t = 390)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_iterative_15.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy Campanile (t = 540)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_iterative_20.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Noisy Campanile (t = 690)</div>
    </div>
</div>
<div class="image-row" style="gap: 20px; margin-top: 10px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Original (campanile.png)</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_iterative_clean.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Iterative Denoising Output</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_onestep.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">One-Step Denoising Output</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A1/campanile_blurred_750.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Gaussian Blur (t = 750)</div>
    </div>
</div>
</section>

<section class="section">
  <h2>1.5 Diffusion Model Sampling</h2>
<div class="image-row" style="gap: 20px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A15/diffuse_sample_1.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 1</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A15/diffuse_sample_2.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 2</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A15/diffuse_sample_3.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 3</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A15/diffuse_sample_4.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 4</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A15/diffuse_sample_5.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 5</div>
    </div>
</div>
</section>

<section class="section">
  <h2>1.6 Classifier-Free Guidance</h2>
  <p>To implement the classifier-free guidance, we essentially use the code from the previous section, but modify the noise estimation. We generate both a noise estimate with and without conditioning, then combine them to guide the sampling process more effectively. We combine them using the equation \(\epsilon = \epsilon_u + \gamma (\epsilon_c - \epsilon_u)\). This results in the following images, which look much better!</p>
<div class="image-row" style="gap: 20px;">
    <div class="image-block" style="flex: 1;">
        <img src="./A16/cond_sample_1.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 1</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A16/cond_sample_2.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 2</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A16/cond_sample_3.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 3</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A16/cond_sample_4.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 4</div>
    </div>
    <div class="image-block" style="flex: 1;">
        <img src="./A16/cond_sample_5.png" style="width: 100%; max-width: none; height: auto;">
        <div class="caption">Sample 5</div>
    </div>
</div>
</section>

<section class="section">
    <h2>1.7 Image-to-image Translation</h2>
    <p>
        For image-to-image translation, we begin the denoising process from an intermediate timestep by providing a partially noised image, rather than starting from pure noise. The diffusion model then denoises this input, effectively translating it into a new image. Notably, the later the starting timestep (i.e., the less noise added), the more the output resembles the original image, since less transformation occurs during denoising.
    </p>
    <div class="image-row" style="gap: 20px;">
        <div class="image-block" style="flex: 1;">
            <img src="./A17/campanile1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile<br><code>(i_start = 1)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/campanile3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile<br><code>(i_start = 3)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/campanile5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile<br><code>(i_start = 5)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/campanile7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile<br><code>(i_start = 7)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/campanile10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile<br><code>(i_start = 10)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/campanile20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile<br><code>(i_start = 20)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A1/campanile.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile<br>(original)</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./A17/penguin1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Penguin<br><code>(i_start = 1)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/penguin3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Penguin<br><code>(i_start = 3)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/penguin5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Penguin<br><code>(i_start = 5)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/penguin7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Penguin<br><code>(i_start = 7)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/penguin10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Penguin<br><code>(i_start = 10)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/penguin20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Penguin<br><code>(i_start = 20)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/penguin_orig.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Penguin<br>(original)</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./A17/shoes1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Shoes<br><code>(i_start = 1)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/shoes3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Shoes<br><code>(i_start = 3)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/shoes5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Shoes<br><code>(i_start = 5)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/shoes7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Shoes<br><code>(i_start = 7)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/shoes10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Shoes<br><code>(i_start = 10)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/shoes20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Shoes<br><code>(i_start = 20)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A17/shoes_orig.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Shoes<br>(original)</div>
        </div>
    </div>
        
    </div>
</section>
<section class="section">
  <h2>1.7.1 Editing Hand-Drawn and Web Images</h2>
    <p>Here, we do the same image-to-image translation process as before, starting the denoising from various intermediate timesteps to observe how the output changes with different levels of initial noise.</p>
    <div class="image-row" style="gap: 20px;">
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cat1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cat<br><code>(i_start = 1)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cat3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cat<br><code>(i_start = 3)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cat5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cat<br><code>(i_start = 5)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cat7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cat<br><code>(i_start = 7)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cat10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cat<br><code>(i_start = 10)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cat20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cat<br><code>(i_start = 20)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cat_original.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cat<br>(original)</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cube1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cube<br><code>(i_start = 1)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cube3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cube<br><code>(i_start = 3)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cube5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cube<br><code>(i_start = 5)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cube7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cube<br><code>(i_start = 7)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cube10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cube<br><code>(i_start = 10)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cube20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cube<br><code>(i_start = 20)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/cube_original.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Cube<br>(original)</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/eye1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Eye<br><code>(i_start = 1)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/eye3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Eye<br><code>(i_start = 3)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/eye5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Eye<br><code>(i_start = 5)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/eye7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Eye<br><code>(i_start = 7)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/eye10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Eye<br><code>(i_start = 10)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/eye20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Eye<br><code>(i_start = 20)</code></div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./handdrawn/eye_original.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Eye<br>(original)</div>
        </div>
    </div>
</section>
<section class="section">
    <h2>1.7.2 Inpainting</h2>
    <p>To facilitate inpainting, we simply change the equation for the denoising process. When the mask is zero, we keep the original pixel value, and otherwise, we apply the denoising step as usual. This leads to the dark regions of the mask being preserved while the white regions are filled in with new content generated by the model.</p>
    <div class="image-row" style="gap: 20px;">
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/campanile_orig.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">campanile</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/campanile_mask.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Mask</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/campanile_replace.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Hole to Fill</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/campanile_infill.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">campanile inpainted<br>(wizard hat???)</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/dog_orig.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">dog</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/dog_mask.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Mask</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/dog_replace.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Hole to Fill</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/dog_infill.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">dog inpainted<br>(no more ball :()</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/mountain_orig.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">mountain</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/mountain_mask.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Mask</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/mountain_replace.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Hole to Fill</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./inpainting/mountain_infill.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">mountain inpainted</div>
        </div>
    </div>
</section>
<section class="section">
    <h2>1.7.3 Text-Conditioned Image-to-Image Translations</h2>
    <p>To implement text-conditioned Image-to-Image translations, we simply change the conditioned prompt embeddings from simply "a high quality photo" (corresponding to the natural image manifold) to whatever prompt we desire.</p>
    The prompts used for each image are as follows:
    <ul>
        <li>Amalfi: "a photo of the amalfi cost"</li>
        <li>Chef: "'a realistic iphone photo of a chef flipping a burger'"</li>
        <li>Sunset: "a photo of a sunset"</li>
    </ul>
    <div class="image-row" style="gap: 20px;">
        <div class="image-block" style="flex: 1;">
            <img src="./translation/amalfi1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Amalfi<br>Noise level 1</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/amalfi3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Amalfi<br>Noise level 3</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/amalfi5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Amalfi<br>Noise level 5</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/amalfi7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Amalfi<br>Noise level 7</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/amalfi10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Amalfi<br>Noise level 10</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/amalfi20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Amalfi<br>Noise level 20</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./A1/campanile.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Campanile</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./translation/chef1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Chef<br>Noise level 1</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/chef3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Chef<br>Noise level 3</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/chef5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Chef<br>Noise level 5</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/chef7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Chef<br>Noise level 7</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/chef10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Chef<br>Noise level 10</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/chef20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Chef<br>Noise level 20</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/chef_final.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Stressed Guy</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./translation/sunset1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sunset<br>Noise level 1</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/sunset3.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sunset<br>Noise level 3</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/sunset5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sunset<br>Noise level 5</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/sunset7.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sunset<br>Noise level 7</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/sunset10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sunset<br>Noise level 10</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/sunset20.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sunset<br>Noise level 20</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./translation/sunset_final.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Twice</div>
        </div>
    </div>
</section>
<section class="section">
    <h2>1.8 Visual Anagrams</h2>
    <p>To implement these visual anagrams, I modified the usual iterative denoising process to enforce two textual constraints simultaneously. First, I run the image through the UNet using the first prompt embedding, applying classifier-free guidance with an unconditional noise estimate. Then, I flip the image, and run it through the UNet again using the second prompt embedding, then I average the results to create a single image that satisfies both prompts.</p>
    <div class="image-row" style="gap: 20px;">
        <div class="image-block" style="flex: 1;">
            <img src="./anagrams/snowy_village.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Snowy Village</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./anagrams/birthday_party.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Birthday Party</div>
        </div>
    </div>
    <div class="image-row" style="gap: 20px; margin-top: 10px;">
        <div class="image-block" style="flex: 1;">
            <img src="./anagrams/queen.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Queen</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./anagrams/tree.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Tree</div>
        </div>
    </div>
</section>

<section class="section">
    <h2>1.9 Hybrid Images</h2>
    <p>To generate hybrid images, I combined low frequency information from one prompt with high frequency information from the other. To do this, I run a given image through the UNet twice, once conditioned on the first prompt and again conditioned on the second prompt. Then, I applied a Gaussian blur to extract the low frequency components from the first prompt's noise. For the second prompt's noise, I subtracted the Gaussian blur of itself from itself to get the high frequency components. Adding these together produces the final hybrid image.</p>
    <div class="image-row" style="gap: 20px;">
        <div class="image-block" style="flex: 1;">
            <img src="./anagrams/bee_sunset.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">a photo of a bee, and a photo of a sunset</div>
        </div>
        <div class="image-block" style="flex: 1;">
            <img src="./anagrams/cat_ship.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">a photo of a cat, and a painting of a ship sailing a sea of grass</div>
        </div>
    </div>
</section>

<h1>Part B: Flow Matching from Scratch!</h1>
<section class="section">
    <h2>Part 1: Training a Single-Step Denoising UNet</h2>
    <h3>Visualization of the Noising Process</h3>
    <div class="image-row" style="justify-content: center;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/noise_levels.png" style="width: 100%; max-width: 1000px; height: auto;">
            <div class="caption">Visualization of noise levels during the noising process</div>
        </div>
    </div>
    <h3>Training the UNet</h3>
    Implementing the UNet was relatively straightforward. I first filled out all the blocks (Conv, DownConv, UpConv, etc.) and then assembled them into the full UNet architecture, which included downsampling and upsampling paths, with skip connections between them. The training loss curve is shown below:
    <div class="image-row" style="justify-content: center;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/loss.png" style="width: 100%; max-width: 1000px; height: auto;">
            <div class="caption">Training loss curve for the single-step denoising UNet</div>
        </div>
    </div>
    <h3>Sample results within distribution</h3>
    Here are some sample results with noise level 0.5 after epochs 1 and 5. It is clear that after epoch 1, there is some imprint of the original image, but after epoch 5, the denoised image is very similar to the original.
    <div class="image-row" style="justify-content: stretch;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/epoch1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Epoch 1 (noise level 0.5)</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/epoch5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Epoch 5 (noise level 0.5)</div>
        </div>
    </div>
    <h3>Sample results out of distribution</h3>
    Here are some sample results out of distribution. It is clear that while it still is effective at some noise levels, once the noise level gets too high, the denoised images become noticeably worse. In the following visual, original images are on the left, the noisy images are in the middle, and the denoised images are on the right.
    <div class="image-row" style="justify-content: stretch;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/ood.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Out-of-distribution: Visualization of noise levels (top to bottom: 0.0, 0.2, 0.4, 0.5, 0.6, 0.8, 1.0)</div>
        </div>
    </div>
    <h3>Denoising Pure Noise</h3>
    We use the UNet to denoise pure, random Gaussian noise. Here is the training loss curve for this process. It is noticeable that the loss is higher than the loss curve from training the UNet on images from the dataset, which is expected since denoising pure noise is a more difficult task.
    <div class="image-row" style="justify-content: center;"></div>
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/noise_loss.png" style="width: 100%; max-width: 1000px; height: auto;">
            <div class="caption">Training loss curve for denoising pure noise</div>
        </div>
    </div>
    Here are the results of denoising pure noise at different epochs.
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/purenoise1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Denoising pure noise – Epoch 1</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B1/purenoise5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Denoising pure noise – Epoch 5</div>
        </div>
    </div>
    For epoch 1, the model maps it to some vague noise pattern, and on epoch 5, the model generates the same roughly "8"-shaped pattern each time. This could be because the model has collapsed to predicting the mean of the MNIST distribution, which would minimize the MSE loss without conditioning.
</section>

<section class="section">
    <h2>Part 2: Training a Flow Matching Model</h2>

    <h3>Part 2.1: Adding Time Conditioning to the UNet</h3>
    To add time conditioning to the UNet, I added two new <code>FCBlocks</code> (fully-connected blocks), which consist of a linear layer, a GELU activation, and another linear layer. These blocks take in the time <code>t</code> and are injected into the UNet during the upsampling stage. 
    <h3>Part 2.2: Training the UNet</h3>
    The training plot for the time-conditioned UNet is shown below.
    <div class="image-row" style="justify-content: center;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/time_loss.png" style="width: 100%; max-width: 1000px; height: auto;">
            <div class="caption">Training loss curve for the time-conditioned UNet</div>
        </div>
    </div>
    <h3>Part 2.3: Sampling from the UNet</h3>
    Again, we pass in noise to the model and sample from it after epochs 1, 5, and 10.
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/time_epoch1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 1</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/time_epoch5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 5</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/time_epoch10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 10</div>
        </div>
    </div>
    The results are pretty bad, but there is some structure emerging by epoch 10.
    <h3>Part 2.4: Adding Class-Conditioning to UNet</h3>
    Similar to the time conditioning, I added another two <code>FCBlocks</code> that take in the one-hot encoded class labels and inject them along with the time conditioning during the upsampling stage.
    <h3>Part 2.5: Training the UNet (Class-Conditioned)</h3>
    <div class="image-row" style="justify-content: center;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/class_loss.png" style="width: 100%; max-width: 1000px; height: auto;">
            <div class="caption">Training loss curve for the class-conditioned UNet</div>
        </div>
    </div>
    <h3>Part 2.6: Sampling from the UNet (Class-Conditioned)</h3>
    Finally, we sample from the class-conditioned UNet after epochs 1, 5, and 10.
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/class_epoch1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 1</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/class_epoch5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 5</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/class_epoch10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 10</div>
        </div>
    </div>
    It is evident that by the 10th epoch, the model is generating very convincing MNIST digits that correspond to the class labels! Yay!
    <h3>Getting rid of that pesky learning rate scheduler</h3>
    To remove the learning rate scheduler, I simply removed the scheduler and decreased the starting learning rate to 5e-3. This seemed to work well enough without any major issues.
    <h3>Sampling from the UNet (No Scheduler)</h3>
    Here are the sampling results after epochs 1, 5, and 10 with no learning rate scheduler:
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/no_sched_epoch1.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 1 (no scheduler)</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/no_sched_epoch5.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 5 (no scheduler)</div>
        </div>
    </div>
    <div class="image-row" style="justify-content: stretch; margin-top: 10px;">
        <div class="image-block" style="flex: 1 1 100%;">
            <img src="./B2/no_sched_epoch10.png" style="width: 100%; max-width: none; height: auto;">
            <div class="caption">Sampling result – Epoch 10 (no scheduler)</div>
        </div>
    </div>
</section>

</body>
</html>
